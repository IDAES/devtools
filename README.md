# idaes-devtools

## Installation

```console
conda create --name idaes-devtools python=3.9 && conda activate idaes-devtools
pip install "idaes-devtools @ https://github.com/IDAES/devtools/archive/main.zip"
idaes-devtools
```

## deprector: the DEPRecation detECTOR

Collect and analyze deprecation messages generated by `pyomo.common.deprecation.deprecation_warning()` and its client functions.

### Concepts

- Deprecation record: an instance of a deprecation warning being emitted
- Deprecation source: location in the codebase that generates the deprecations
- Source matching: associate a deprecation record with its probable source
- Source package: the package whose codebase contains the calls to `deprecation_warning()`
- Client package: the package whose code base causes deprecations to be emitted

#### Collection

- The package's own test suite is used to collect the deprecations, with additional CLI flags (after the `--`) being passed as-is to the underlying `pytest` invocation
  - `deprector collect idaes` will run `pytest --pyargs idaes`
  - `deprector collect idaes -- -m unit` will run `pytest --pyargs idaes -m unit`

#### Analysis

- The `analyze` phase will use the output of the `collect` phase (default: `deprector.json`) and match deprecation records with sources within the package's codebase
- The checks are implemented as a custom pytest plugin operating on a per-file, per-source-line base (i.e. the pass/fail status is for each line of each file)
- When the source package and client package are the same, use the `--callsite-registry` option to exclude known locations in the package's source code where `deprecation_warning()` is called so that they can be skipped when extracting the primary source for each record
  - Currently only the `idaes` registry is provided
  - Additional registry shouldn't be needed unless one needs to e.g. collect deprecations emitted within the Pyomo codebase (in which case a `pyomo` registry can be created)

## Usage

### :warning: IMPORTANT :warning:

 Due to the still-limited amount of testing and the intrinsic interaction with a package's test suite and source code, it is **heavily recommended** to use the following precautions when running `deprector`:

- Use a **dedicated Conda environment (i.e. separate from the IDAES developer environment)** to install `idaes-devtools` (for the moment)
- **Change directory to an empty directory** (or at the very least **not** the package's own source tree) before running `deprector`

### Installing the packages to be tested

- Since `deprector` is installed in a separate environment, the package to be tested should also be installed in the same environment
- Both editable (`pip install -e /path/to/package`) and non-editable (`pip install package`, `pip install "package @ https://github.com/myorg/myrepo/archive/main.zip`) installations are supported; `deprector` should work the same in both cases (i.e. `deprector collect package` should generate the same results, minus the paths of the source files) 

### Examples

#### Testing deprecations within IDAES itself (editable install)

```console
mkdir ~/my-idaes-source
git clone https://github.com/IDAES/idaes-pse ~/my-idaes-source
conda activate idaes-devtools
pip install -e ~/my-idaes-source
mkdir /tmp/deprector/idaes && cd /tmp/deprector/idaes
deprector collect idaes -- -m unit
deprector analyze idaes --callsite-registry idaes
```

#### Testing deprecations for a client package `myclient` (installed from PyPI)

```console
conda activate idaes-devtools
pip install myclient
mkdir /tmp/deprector/myclient && cd /tmp/deprector/myclient
deprector collect myclient
deprector analyze myclient
```
